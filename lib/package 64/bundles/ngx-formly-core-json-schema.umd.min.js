!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("@angular/forms"),require("@ngx-formly/core"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@ngx-formly/core/json-schema",["exports","@angular/core","@angular/forms","@ngx-formly/core","rxjs/operators"],r):r((e["ngx-formly"]=e["ngx-formly"]||{},e["ngx-formly"].core=e["ngx-formly"].core||{},e["ngx-formly"].core["json-schema"]={}),e.ng.core,e.ng.forms,e["ngx-formly"].core,e.rxjs.operators)}(this,function(e,r,a,p,t){"use strict";var m=function(){return(m=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var i in r=arguments[t])Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i]);return e}).apply(this,arguments)};function d(e,r){var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&r.indexOf(n)<0&&(t[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)r.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(t[n[i]]=e[n[i]])}return t}function c(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,i,o=t.call(e),a=[];try{for(;(void 0===r||0<r--)&&!(n=o.next()).done;)a.push(n.value)}catch(u){i={error:u}}finally{try{n&&!n.done&&(t=o["return"])&&t.call(o)}finally{if(i)throw i.error}}return a}function y(e){return""===e||e===undefined||null===e}function h(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}function v(e){return e.hasOwnProperty("const")||e["enum"]&&1===e["enum"].length}function O(e){if(!e.fieldGroup)return e.key&&p.ɵgetFieldValue(e)!==undefined?1:0;var r=e.fieldGroup.reduce(function(e,r){return O(r)+e},0);if(0===r&&e.key){var t=p.ɵgetFieldValue(e);if(null===t||t!==undefined&&(e.fieldArray&&Array.isArray(t)||!e.fieldArray&&h(t)))return 1}return r}var n=function(){function e(){}return e.prototype.toFieldConfig=function(e,r){return this._toFieldConfig(e,m({schema:e},r||{}))},e.prototype._toFieldConfig=function(u,e){var o=this,r=e.key,l=d(e,["key"]);u=this.resolveSchema(u,l);var s={type:this.guessType(u),defaultValue:u["default"],templateOptions:{label:u.title,readonly:u.readOnly,description:u.description}};switch(null!=r&&(s.key=r),l.ignoreDefault||!u.readOnly&&!l.readOnly||(s.templateOptions.disabled=!0,l=m({},l,{readOnly:!0})),l.resetOnHide&&(s.resetOnHide=!0),r&&l.strict&&this.addValidator(s,"type",function(e,r){var t=p.ɵgetFieldValue(r);if(null!=t)switch(s.type){case"string":return"string"==typeof t;case"integer":return function n(e){return Number.isInteger?Number.isInteger(e):"number"==typeof e&&Math.floor(e)===e}(t);case"number":return"number"==typeof t;case"object":return h(t);case"array":return Array.isArray(t)}return!0}),!1===l.shareFormControl&&(s.shareFormControl=!1),l.ignoreDefault&&delete s.defaultValue,s.type){case"null":this.addValidator(s,"null",function(e){return null===e.value});break;case"number":case"integer":s.parsers=[function(e){return y(e)?""===e?null:e:Number(e)}],u.hasOwnProperty("minimum")&&(s.templateOptions.min=u.minimum),u.hasOwnProperty("maximum")&&(s.templateOptions.max=u.maximum),u.hasOwnProperty("exclusiveMinimum")&&(s.templateOptions.exclusiveMinimum=u.exclusiveMinimum,this.addValidator(s,"exclusiveMinimum",function(e){var r=e.value;return y(r)||r>u.exclusiveMinimum})),u.hasOwnProperty("exclusiveMaximum")&&(s.templateOptions.exclusiveMaximum=u.exclusiveMaximum,this.addValidator(s,"exclusiveMaximum",function(e){var r=e.value;return y(r)||r<u.exclusiveMaximum})),u.hasOwnProperty("multipleOf")&&(s.templateOptions.step=u.multipleOf,this.addValidator(s,"multipleOf",function(e){var r=e.value;if(y(r)||"number"!=typeof r||0===r||u.multipleOf<=0)return!0;var t=Math.pow(10,function n(e){if(!isFinite(e))return 0;for(var r=1,t=0;Math.round(e*r)/r!==e;)r*=10,t++;return t}(u.multipleOf));return Math.round(r*t)%Math.round(u.multipleOf*t)==0}));break;case"string":var t=u.type;Array.isArray(t)&&-1!==t.indexOf("null")&&(s.parsers=[function(e){return y(e)?null:e}]),["minLength","maxLength","pattern"].forEach(function(e){u.hasOwnProperty(e)&&(s.templateOptions[e]=u[e])});break;case"object":s.fieldGroup||(s.fieldGroup=[]);var n=c(this.resolveDependencies(u),2),f=n[0],i=n[1];Object.keys(u.properties||{}).forEach(function(a){var e=o._toFieldConfig(u.properties[a],m({},l,{key:a}));if(s.fieldGroup.push(e),(Array.isArray(u.required)&&-1!==u.required.indexOf(a)||f[a])&&(e.expressionProperties=m({},e.expressionProperties||{},{"templateOptions.required":function(r,e,t){for(var n=t.parent,i=t.fieldGroup&&null!=t.key?n.model:t.model;null==n.key&&n.parent;)n=n.parent;var o=!(!n||!n.templateOptions)&&n.templateOptions.required;return!(!i&&!o)&&(!(!Array.isArray(u.required)||-1===u.required.indexOf(a))||f[a]&&r&&f[a].some(function(e){return!y(r[e])}))}})),i[a]){var r=i[a].oneOf;r&&r.every(function(e){return e.properties&&e.properties[a]&&v(e.properties[a])})?r.forEach(function(e){var r=e.properties,t=a,n=r[t],i=d(r,["symbol"==typeof t?t:t+""]);s.fieldGroup.push(m({},o._toFieldConfig(m({},e,{properties:i}),m({},l,{resetOnHide:!0})),{hideExpression:function(e){return!e||((r=n).hasOwnProperty("const")?r["const"]:r["enum"][0])!==e[a];var r}}))}):s.fieldGroup.push(m({},o._toFieldConfig(i[a],l),{hideExpression:function(e){return!e||y(e[a])}}))}}),u.oneOf&&s.fieldGroup.push(this.resolveMultiSchema("oneOf",u.oneOf,m({},l,{shareFormControl:!1}))),u.anyOf&&s.fieldGroup.push(this.resolveMultiSchema("anyOf",u.anyOf,l));break;case"array":if(u.hasOwnProperty("minItems")&&(s.templateOptions.minItems=u.minItems,this.addValidator(s,"minItems",function(e){var r=e.value;return y(r)||r.length>=u.minItems})),u.hasOwnProperty("maxItems")&&(s.templateOptions.maxItems=u.maxItems,this.addValidator(s,"maxItems",function(e){var r=e.value;return y(r)||r.length<=u.maxItems})),u.hasOwnProperty("uniqueItems")&&(s.templateOptions.uniqueItems=u.uniqueItems,this.addValidator(s,"uniqueItems",function(e){var r=e.value;return!(!y(r)&&u.uniqueItems)||Array.from(new Set(r.map(function(e){return JSON.stringify(e)}))).length===r.length})),u.items&&!Array.isArray(u.items)&&(u.items=this.resolveSchema(u.items,l)),!this.isEnum(u)){var a=this;Object.defineProperty(s,"fieldArray",{get:function(){if(u.items&&!Array.isArray(u.items))return a._toFieldConfig(u.items,l);var e=this.fieldGroup?this.fieldGroup.length:0;if(u.items&&u.items[e]){var r=a._toFieldConfig(u.items[e],m({},l));return r.templateOptions.removable=!1,r}return u.additionalItems?a._toFieldConfig(u.additionalItems,l):{}},enumerable:!0,configurable:!0})}}return u.hasOwnProperty("const")&&(s.templateOptions["const"]=u["const"],this.addValidator(s,"const",function(e){return e.value===u["const"]}),s.type||(s.defaultValue=u["const"])),this.isEnum(u)&&(s.templateOptions.multiple="array"===s.type,s.type="enum",s.templateOptions.options=this.toEnumOptions(u)),u.oneOf&&!s.type&&(delete s.key,s.fieldGroup=[this.resolveMultiSchema("oneOf",u.oneOf,m({},l,{key:r,shareFormControl:!1}))]),u.widget&&u.widget.formlyConfig&&(s=this.mergeFields(s,u.widget.formlyConfig)),l.map?l.map(s,u):s},e.prototype.resolveSchema=function(e,r){return e&&e.$ref&&(e=this.resolveDefinition(e,r)),e&&e.allOf&&(e=this.resolveAllOf(e,r)),e},e.prototype.resolveAllOf=function(e,i){var o=this,r=e.allOf,t=d(e,["allOf"]);if(!r.length)throw Error("allOf array can not be empty "+r+".");return r.reduce(function(r,t){return t=o.resolveSchema(t,i),r.required&&t.required&&(r.required=function n(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(c(arguments[r]));return e}(r.required,t.required)),t.uniqueItems&&(r.uniqueItems=t.uniqueItems),["maxLength","maximum","exclusiveMaximum","maxItems","maxProperties"].forEach(function(e){y(r[e])||y(t[e])||(r[e]=r[e]<t[e]?r[e]:t[e])}),["minLength","minimum","exclusiveMinimum","minItems","minProperties"].forEach(function(e){y(r[e])||y(t[e])||(r[e]=r[e]>t[e]?r[e]:t[e])}),p.ɵreverseDeepMerge(r,t)},t)},e.prototype.resolveMultiSchema=function(l,s,f){var p=this;return{type:"multischema",fieldGroup:[{type:"enum",defaultValue:-1,templateOptions:{multiple:"anyOf"===l,options:s.map(function(e,r){return{label:e.title,value:r,disabled:e.readOnly}})},hooks:{onInit:function(e){return e.formControl.valueChanges.pipe(t.tap(function(){return e.options._checkField(e.parent)}))}}},{fieldGroup:s.map(function(e,u){return m({},p._toFieldConfig(e,m({},f,{resetOnHide:!0})),{hideExpression:function(e,r,t,n){var i=t.parent.parent.fieldGroup[0].formControl;if(-1===i.value||n){var o=t.parent.fieldGroup.map(function(e,r){return[e,r,p.isFieldValid(e,r,s,f)]}).sort(function(e,r){var t=c(e,3),n=t[0],i=(t[1],t[2]),o=c(r,3),a=o[0],u=(o[1],o[2]);if(i!==u)return u?1:-1;var l=O(n),s=O(a);return l===s?n.templateOptions.disabled===a.templateOptions.disabled?0:n.templateOptions.disabled?1:-1:l<s?1:-1}).map(function(e){return c(e,2)[1]});if("anyOf"===l){var a=o.filter(function(e){return O(t.parent.fieldGroup[e])});o=0<a.length?a:[o[0]||0]}o=0<o.length?o:[0],i.setValue("anyOf"===l?o:o[0])}return Array.isArray(i.value)?-1===i.value.indexOf(u):i.value!==u}})})}]}},e.prototype.resolveDefinition=function(t,e){var r=c(t.$ref.split("#/"),2),n=r[0],i=r[1];if(n)throw Error("Remote schemas for "+t.$ref+" not supported yet.");var o=i?i.split("/").reduce(function(e,r){return e&&e.hasOwnProperty(r)?e[r]:null},e.schema):null;if(!o)throw Error("Cannot find a definition for "+t.$ref+".");return o.$ref?this.resolveDefinition(o,e):m({},o,["title","description","default","widget"].reduce(function(e,r){return t.hasOwnProperty(r)&&(e[r]=t[r]),e},{}))},e.prototype.resolveDependencies=function(t){var n={},i={};return Object.keys(t.dependencies||{}).forEach(function(r){var e=t.dependencies[r];Array.isArray(e)?e.forEach(function(e){n[e]?n[e].push(r):n[e]=[r]}):i[r]=e}),[n,i]},e.prototype.guessType=function(e){var r=e?e.type:null;if(!r&&e&&e.properties)return"object";if(Array.isArray(r)){if(1===r.length)return r[0];if(2===r.length&&-1!==r.indexOf("null"))return r["null"===r[0]?1:0]}return r},e.prototype.addValidator=function(e,r,t){e.validators=e.validators||{},e.validators[r]=t},e.prototype.isEnum=function(e){return e["enum"]||e.anyOf&&e.anyOf.every(v)||e.oneOf&&e.oneOf.every(v)||e.uniqueItems&&e.items&&!Array.isArray(e.items)&&this.isEnum(e.items)},e.prototype.toEnumOptions=function(e){if(e["enum"])return e["enum"].map(function(e){return{value:e,label:e}});var r=function(e){var r=e.hasOwnProperty("const")?e["const"]:e["enum"][0],t={value:r,label:e.title||r};return e.readOnly&&(t.disabled=!0),t};return e.anyOf?e.anyOf.map(r):e.oneOf?e.oneOf.map(r):this.toEnumOptions(e.items)},e.prototype.isFieldValid=function(e,r,t,n){e._schemasFields||(Object.defineProperty(e,"_schemasFields",{enumerable:!1,writable:!0,configurable:!0}),e._schemasFields={});var i=e._schemasFields[r],o=e.model?p.ɵclone(e.model):e.fieldArray?[]:{};return i?(i.model=o,e.options._buildField(i)):i=e._schemasFields[r]=e.options._buildField({formControl:Array.isArray(o)?new a.FormArray([]):new a.FormGroup({}),fieldGroup:[this._toFieldConfig(t[r],m({},n,{resetOnHide:!0,ignoreDefault:!0,map:null,strict:!0}))],model:o,options:{}}),i.formControl.valid},e.prototype.mergeFields=function(e,r){for(var t in r)h(e[t])&&h(r[t])?e[t]=this.mergeFields(e[t],r[t]):null!=r[t]&&(e[t]=r[t]);return e},e.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],e.ngInjectableDef=r.defineInjectable({factory:function(){return new e},token:e,providedIn:"root"}),e}();e.FormlyJsonschema=n,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ngx-formly-core-json-schema.umd.min.js.map